<html>
<head>
    <meta charset="UTF-8"/>
    <title>音声案内</title>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script>

        /*
        data code 説明
        ABC
        A 棟
         1中学棟 2高校棟 3渡り廊下 4図書館棟
        B 階
         1中学棟1階 2中学棟2階(高校棟1階) 3中学棟3階(高校棟2階) 4高校棟3階
        C 場所
         0階段右 1A 2B 3C 4D 5E
         */

        var data = [
            ["書道", "書道部 1A教室", "書道部　中学棟1階　1年A組", "書道部", 111],
            ["将棋", "囲碁将棋部 2A教室", "囲碁将棋部　中学棟2階　2年A組", "囲碁将棋部", 121],
            ["迷路", "迷路 2D教室", "迷路　中学棟2階　2年D組", "迷路", 124],
            ["数学", "数学研究部 3A教室", "数学研究部　中学棟3階　3年A組", "数学研究部", 131],
            ["ポケモン", "ポケモン同好会 3D教室前半", "ポケモン同好会　中学棟3階　3年D組　まえ半分", "ポケモン同好会", 134],
            ["ドラえもん", "ドラえもん同好会 3D教室後半", "ポケモン同好会　中学棟3階　3年D組　うしろ半分", "ドラえもん同好会", 134],
            ["音楽", "音楽部 4A教室", "音楽部　高校棟3階　4年A組", "音楽部", 241],
            ["暗号", "暗号同好会 4B教室前半", "暗号同好会　高校棟3階　4年B組　まえ半分", "暗号同好会", 242],
            ["文芸", "文藝同好会 4B教室後半", "文藝同好会　高校棟3階　4年B組　うしろ半分", "文藝同好会", 242],
            ["文藝", "文藝同好会 4B教室後半", "文藝同好会　高校棟3階　4年B組　うしろ半分", "文藝同好会", 242],
            ["折り紙", "折り紙同好会 4C教室", "折り紙同好会　高校棟3階　4年C組", "折り紙同好会", 243],
            ["mga", "MGA同好会 4D教室", "MGA同好会　高校棟3階　4年D組", "MGA同好会", 244],
            ["謎解き", "謎解きの会 4E教室", "謎解きの会　高校棟3階　4年E組", "謎解きの会", 245],
            ["美術", "美術部 美術室", "美術部　高校棟3階　美術室", "美術部", 240],
            ["情報", "情報同好会 情報教室", "情報同好会　高校棟3階　情報教室", "情報同好会", 240],
            ["魚", "観賞魚同好会 5A教室前半", "観賞魚同好会　高校棟2階　5年A組　まえ半分", "観賞魚同好会", 231],
            ["ロケット", "ロケット同好会 5A教室後半", "ロケット同好会　高校棟2階　5年A組　うしろ半分", "ロケット同好会", 231],
            ["歴史", "歴史部菁史会 5B教室", "歴史部菁史会　高校棟2階　5年B組", "歴史部菁史会", 232],
            ["写真", "写真部 5C教室", "写真部　高校棟2階　5年C組", "写真部", 233],
            ["登山", "登山同好会 5D教室前半", "登山同好会　高校棟2階　5年D組　まえ半分", "登山同好会", 234],
            ["紅茶", "紅茶同好会 5D教室後半", "紅茶同好会　高校棟2階　5年D組　うしろ半分", "紅茶同好会", 234],
            ["マジック", "マジック同好会 5E教室", "マジック同好会　高校棟2階　5年E組", "マジック同好会", 235],
            ["科学", "科学部 生物室・物理室", "科学部　高校棟2階　生物室　物理室", "科学部", 230],
            ["新聞", "新聞部 渡り廊下", "新聞部　中学棟3階　高校棟2階間　渡り廊下", "新聞部", 330],
            ["園芸", "園芸部 6A教室", "園芸部　高校棟1階　6年A組", "園芸部", 221],
            ["クイズ", "クイズ研究部 6B教室", "クイズ研究部　高校棟1階　6年B組", "クイズ研究部", 222],
            ["工作", "電子工作部 6C教室", "電子工作部　高校棟1階　6年C組", "電子工作部", 223],
            ["英語", "英語部 6D教室前半", "英語部　高校棟1階　6年D組　まえ半分", "英語部", 224],
            ["チェス", "チェス研究同好会 6D教室後半", "チェス研究同好会　高校棟1階　6年D組　うしろ半分", "チェス同好会", 224],
            ["鉄道", "鉄道研究部 6E教室前半", "鉄道研究部　高校棟1階　6年E組　まえ半分", "鉄道研究部", 225],
            ["交通", "交通軍事同好会 6E教室後半", "交通軍事同好会　高校棟1階　6年E組　うしろ半分", "交通軍事同好会", 225],
            ["軍事", "交通軍事同好会 6E教室後半", "交通軍事同好会　高校棟1階　6年E組　うしろ半分", "交通軍事同好会", 225],
            ["アニメ", "アニメ・ラーメン・声優研究会 音楽室", "アニメ・ラーメン・声優研究会　高校棟1階　音楽室", "アニメ・ラーメン・声優研究会", 220],
            ["ラーメン", "アニメ・ラーメン・声優研究会 音楽室", "アニメ・ラーメン・声優研究会　高校棟1階　音楽室", "アニメ・ラーメン・声優研究会", 220],
            ["声優", "アニメ・ラーメン・声優研究会 音楽室", "アニメ・ラーメン・声優研究会　高校棟1階　音楽室", "アニメ・ラーメン・声優研究会", 220],
            ["東", "東菁会　演習室A", "東菁会　図書館棟　図書館下　演習室A", "東菁会", 420],
            ["お化け", "お化け屋敷　演習室B・C", "お化け屋敷　図書館棟　図書館下　演習室B　演習室C", "お化け屋敷", 420]
        ];

        var mode = 1;
        window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
        var recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja';
        recognition.interimResults = true;

        // 録音終了時トリガー
        recognition.addEventListener('result', function (event) {
            var text = event.results.item(0).item(0).transcript;
            switch (mode) {
                case 1:
                    $("#result_text_des").val(text);
                    break;
                case 2:
                    $("#result_text_dep").val(text);
                    break;
            }
        }, false);

        // 録音開始
        function record(num) {
            mode = num;
            recognition.start();
        }

        function search() {
            var tocode,tofrom;
            var test = document.getElementById("result_text_des").value;
            document.getElementById("out_to").value = "見つかりません";
            var outmessage = "見つかりません";
            for (var i = 0; i < data.length; i++) {
                if (test.indexOf(data[i][0]) !== -1) {
                    tocode = data[i][4];
                    outmessage = data[i][2];
                    document.getElementById("out_to").value = data[i][1];
                    break;
                }
            }

            var test = document.getElementById("result_text_dep").value;
            document.getElementById("out_from").value = "見つかりません";
            for (var i = 0; i < data.length; i++) {
                if (test.indexOf(data[i][0]) !== -1) {
                    tofrom = data[i][4];
                    document.getElementById("out_from").value = data[i][1];
                    break;
                }
            }

            // 発話機能をインスタンス化
            var msg = new SpeechSynthesisUtterance();
            //var voices = window.speechSynthesis.getVoices();

            // 以下オプション設定（日本語は効かないもよう。。）
            //msg.voice = voices[7]; // 7:Google 日本人 ja-JP ※他は英語のみ（次項参照）
            msg.volume = 1.0; // 音量 min 0 ~ max 1
            msg.rate = 1.0; // 速度 min 0 ~ max 10
            msg.pitch = 1.0; // 音程 min 0 ~ max 2

            msg.text = outmessage; // 喋る内容
            msg.lang = 'ja-JP'; // en-US or ja-JP
            // msg.lang = 'en-US'; // en-US or ja-JP

            // 発話実行
            speechSynthesis.speak(msg);
            //msg.onend = function(event) {
            //    alert('Finished in ' + event.elapsedTime + ' seconds.');
            //};

            //search section
            var path='';
            if(Math.floor(tocode/10)===Math.floor(tofrom/10)){ //同じ階
                path+='同じ階です';
            }
            else if(Math.floor(tocode/100)===Math.floor(tofrom/100)){ //同じ棟
                switch(Math.floor(tofrom/100)){
                    case 1: //中学棟
                        path+='階段で中学棟'+Math.floor(tofrom/10%10)+'階から'+Math.floor(tocode/10%10)+'階まで移動してください';
                        break;
                    case 2: //高校棟
                        path+='階段で高校棟'+ (Math.floor(tofrom/10%10)-1) +'階から'+(Math.floor(tocode/10%10)-1)+'階まで移動してください';
                        break;
                }
            }
            else if(tocode===330 || tofrom===330){
                if(tocode===330){ //todo: 出発地で分岐
                    path+="階段で中学棟3階または高校棟2階まで移動してください。\n" +
                          "渡り廊下中央にあります。"
                }
                else{
                    if(Math.floor(tocode/100)===1){
                        path+="中学棟3階側に移動して、階段で中学棟3階から"+Math.floor(tocode/10%10)+'階まで移動してください';
                    }
                    else if(Math.floor(tocode/100)===2){
                        path+="高校棟2階側に移動して、階段で高校棟2階から"+(Math.floor(tocode/10%10)-1)+'階まで移動してください';
                    }
                }
            }
            else if(Math.floor(tocode/100)===4){
                path+="中学棟2階または高校棟1階昇降口まで移動してください。\n高校棟昇降口向かって左の図書館棟に入ってください。"
            }
            else if(Math.floor(tofrom/100)===4){
                if(Math.floor(tocode/100)===2){
                    path+="高校棟昇降口まで降りたあと、階段で高校棟1階から"+(Math.floor(tocode/10%10)-1)+'階まで移動してください';
                }
                else{
                    path+="高校棟昇降口まで降りたあと、中学棟昇降口へ向かい階段で中学棟2階から"+(Math.floor(tocode/10%10))+'階まで移動してください';
                }
            }
            document.getElementById("route").value=path;
        }

        function keydown() {
            if (window.event.keyCode === 13) {
                document.getElementById("searchbutton").click();
            }
        }


    </script>
    <style>
        #map {
            width: 75%;
            height: 75%;
        }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
</head>

<body>
<h1 style="text-align: center">test page for 54回菁々祭教室案内</h1>
<div style="text-align: center;">PC・Android版Chromeでのみ音声入力が、多くのブラウザで音声案内が利用可能</div>
<center>
    現在地
    <input id="result_text_dep" type="text" style="font-size: x-large" size="25" maxlength="20"
           onkeydown="keydown()">
    <input type="button" onClick="record(2)" value="音声入力"/>
    <br>
    目的地
    <input id="result_text_des" type="text" style="font-size: x-large" size="25" maxlength="20"
           onkeydown="keydown()">
    <input type="button" onClick="record(1)" value="音声入力"/>
    <br>
    <input type="button" id="searchbutton" onclick="search()" value="検索">
    <br>
    from<input id="out_from" type="text" size="36" style="font-size: x-large" readonly="readonly">
    <br>
    to<input id="out_to" type="text" size="36" style="font-size: x-large" readonly="readonly">
    <br>
    <textarea rows="10" cols="30" id="route" style="font-size: x-large" readonly="readonly"></textarea>
</center>

<center>
    <div id="map"></div>
    <script>
        var map = L.map('map', {
            maxZoom: 24,
            minZoom: 1,
            crs: L.CRS.Simple
        }).setView([0, 0], 1);
        map.setMaxBounds(new L.LatLngBounds([0, 345], [230, 0])); //表示可能範囲
        var imageUrl = 'http://moment-0204.github.io/Code-for-Code/map.png';
        var imageBounds = [[230, 0], [0, 345]]; //初期表示範囲
        L.imageOverlay(imageUrl, imageBounds, {
            attribution: ''
        }).addTo(map);
    </script>
</center>

<!-- シェアボタンに変換される -->
<a class="twitter-share-button" href="https://twitter.com/share" data-dnt="true" style="float: right">Tweet</a>

<!-- [head]内や、[body]の終了直前などに配置 -->
<script>
    window.twttr = (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0], t = window.twttr || {};
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);
        t._e = [];
        t.ready = function (f) {
            t._e.push(f);
        };
        return t;
    }(document, "script", "twitter-wjs"));
</script>
<script>
    var codefordenkou = 25;
    var codemax = 36;
    var dep = codefordenkou;
    var match = location.search.match(/d=(.*?)(&|$)/);
    if (match) {
        dep = decodeURIComponent(match[1]);
        if (dep < 0 || dep > codemax) dep = codefordenkou;
    }
    document.getElementById("result_text_dep").value = data[dep][3];
</script>
</body>
</html>